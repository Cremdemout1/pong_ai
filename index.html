<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Paddle 3D Environment</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
        }
        #controls-2 {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #stats {
            margin-top: 10px;
            line-height: 1.5;
        }
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #reactiveAI, #predictiveAI {
            flex: 1;
            height: 100%;
            width: 50%;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            gap: 10px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #5387f7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #3b6dd9;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .stats-container {
        position: absolute;
        top: 20px;
        left: 20px;
        display: none;
        flex-direction: column;
        gap: 15px; /* space between boxes */
        pointer-events: none;
    }

    .stats-box {
        background: rgba(0, 0, 0, 0);
        padding: 10px;
        top: 20px;
        border-radius: 8px;
        font-size: 14px;
        width: 220px;
        pointer-events: auto; /* allow text selection */
    }

    .ui-header {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        font-size: 1.2em;
    }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="predictiveAI"></canvas>
        <canvas id="reactiveAI"></canvas>
        <div id="ui">
            <div style="display: flex; align-items: center; gap: 10px;">
                <strong>AI Paddle Simulation</strong>
                <button id="moveStatsBtn">Show Stats ↓</button>
            </div>
            <div id="stats-container">
                <div id="stats_left" class="stats-box">
                    <strong>Predictive AI (left/up)</strong>
                    <div>Ball Position: <span class="ballPos">0,0,0</span></div>
                    <div>Ball Velocity: <span class="ballVel">0,0,0</span></div>
                    <div>Paddle Position: <span class="paddlePos">0,0</span></div>
                    <div>AI Action: <span class="aiAction">none</span></div>
                    <div>Predicted Intercept: <span class="intercept">0,0</span></div>
                    <div>Score: <span class="score">0</span></div>
                    <div>Misses: <span class="misses">0</span></div>
                </div>

                <div id="stats_right" class="stats-box right-stats">
                    <strong>Reactive AI (right/down)</strong>
                    <div>Ball Position: <span class="ballPos">0,0,0</span></div>
                    <div>Ball Velocity: <span class="ballVel">0,0,0</span></div>
                    <div>Paddle Position: <span class="paddlePos">0,0</span></div>
                    <div>AI Action: <span class="aiAction">none</span></div>
                    <div>Predicted Intercept: <span class="intercept">0,0</span></div>
                    <div>Score: <span class="score">0</span></div>
                    <div>Misses: <span class="misses">0</span></div>
                </div>
            </div>
        </div>
        </div>
        <div>
            <div id="controls">
                <button id="startBtn">Start Simulation</button>
                <button id="resetBtn">Reset</button>
                <button id="pauseBtn" disabled>Pause</button>
                <button id="lessSpeed">speed -</button>
                <button id="moreSpeed">speed +</button>
            </div>
            <div id="controls-2">
                <a id="documentation" href="documentation.html">
                    <button>Read Documentation</button>
                  </a>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';
        import { predictive_model } from './dist/predictive_model.js';
        import { reactive_model } from './dist/reactive_model.js';

        const predictiveAiWeights = {
            "W_hidden_input": [[0.07571163054980735,-0.09879728658770932,-0.0025411196896264507,1.2834025446819128,-1.4762437387130491,-2.0096605239446923,-0.04497989174719303,0.14464276705798085,-0.14384152071922535,-2.6871606026881096,-0.037192423671404184,0.02891691912057464,-311.3089085534629,0.22422554934879174],[-0.055908044001824246,0.17897313214296667,0.019693933411955793,-0.5555207873771879,2.2761658471179262,0.4055828201728979,0.08063808511155879,-0.05247733265746928,0.18930662438179605,-1.3870115399946836,0.10819959396504145,-0.17703519849842672,0.21735121993685436,-189.5703621437401],[-0.11996995608546475,-0.16821818278725512,-0.026514615265630273,0.520352123122718,-1.3549415695435347,-2.9536055627943325,0.15578515626907521,-0.0031034380345209,-0.25930133582777615,-2.439842863941628,0.005400387386199475,0.13899807600698164,0.011086514603524996,-344.7379207044564],[0.7236220416763963,-0.7871593103401202,-0.24919496022967125,1.9015394668118888,-3.5155533070112055,2.6854562433555818,-0.6834962795564965,0.679048354753963,0.26495820359637,1.7243039339691388,0.27930093887360574,-0.5971802296707363,-2.471654659060362,-245.94307039350815],[-2.019671960006264,-0.4552554572845688,15.809793749060773,-4.979472406891216,-0.6555166883461876,-1.5327924331613594,2.062761900500206,-0.47765952031314085,0.6138937109126485,3.601799382496622,-0.1811326547677063,1.2113076421581033,-1.2295364922849528,2.3901557464885883],[0.25728658284217976,-0.022569852547878164,0.01915896336102582,2.292436855209007,-2.0371010602550226,1.8217104475416137,-0.138520495181266,0.030168343696500587,0.050822933268802196,1.9486108885543594,-0.17303163095891064,-0.0782311195475366,306.533478053833,0.6168269323406569],[-5.077476498576406,-3.783217007223332,0.508926921028604,8.177646077753312,-15.211351776485696,-0.876980750720473,4.252700487941269,1.266400102200764,-0.24846508983015184,-1.5981345783902479,0.6658633679768005,-4.4944315300882645,-6.0136894879371585,-2.8451471648701805],[0.2813295759387656,-0.23039634610601592,-0.20863415124998796,0.8625718396842388,-2.207002890024836,1.8799220975780464,-0.18053700863124647,0.13890810093255304,0.1770980915304153,-1.5416157760064633,0.1305220551356998,-0.1868867783268398,-0.05468156885394678,257.73787489774804],[-0.1291139150396751,-0.305971056100352,0.1848967650463433,-0.9415930364495617,1.880637367153625,-2.7239235222535947,0.03905840076017982,0.26416629828739535,-0.6437493151592494,-2.29718676163057,0.009946265957835017,0.0650425471060561,-0.5048016679176428,310.5769867828448],[3.0700962227538042,-2.240844280894971,9.652366144098082,-3.319920397073904,8.98419295367224,1.7142406779904562,-2.0252012396690495,-0.5955949335514298,-0.43274840924580144,-1.2694721763951071,-2.200798866694345,-0.32225619585529414,-5.573865701783698,7.5583317441730244],[0.11709059555324605,0.015467543734551415,-0.11442797399781522,-0.7890912398098265,1.3026122649321992,0.6166225733936866,0.03572383519838623,0.0935330428667419,0.6847475335566203,2.192350259882323,-0.12751882887273813,-0.000010840398174364866,-242.5461858393826,-0.03143053740709588],[0.08643936911585474,-0.003811546995645865,0.03134681026362951,-0.14102672668016178,0.7927377534217558,-2.8904705355734923,-0.013111737220672128,0.02185929231092091,-0.7864752325199064,-2.537558240318566,-0.010260937499850433,0.035806261857610475,379.0260097205163,-0.13087664108676106]],
            "W_hidden_output": [[8.441808794552111,-33.106030509716355,-21.910602347630284,-17.47655220581277,1.4383373729040745,-2.8756694985605007,0.7861629352794715,23.14513560564827,20.08447300246348,0.8163995900382018,-4.443163801062265,4.9535036976720885],[7.082982023238169,23.189538835820464,22.016210299696944,24.647903965171082,-0.24541110379151537,-4.406583997731274,-2.633629656321939,-18.02046733969284,-26.107482393495346,-1.106158706196698,-8.11906188272826,1.8450016051976486],[24.852681997262536,9.760592782394216,2.347784046223444,-5.8702280410649585,0.8337743742011335,-19.819306929545693,-1.5417711161069945,-7.825156505412876,6.641781982768545,-0.37197338899338256,26.797266816568367,-26.419180660802475],[-29.836484427635774,9.462268838534634,2.107105164835105,-6.188779657307045,0.14096064612022308,26.180098625362263,0.7662680640213225,-7.1348598246391886,5.391174754373744,-1.6207106304265115,-18.891850162791883,24.124549454167685],[-35.28632183498873,-31.401234866694974,-22.62465299366761,-16.811778271777314,-0.14685252083972575,26.855185215353004,1.7583029840702484,23.46334737709763,21.1435577907907,1.1009595997362445,-18.79395150038529,24.63242186481537],[26.66201645505108,-35.690215393483186,-27.17615090761119,-17.640152875296618,-0.3262412124472861,-19.121904398266935,4.102492019689961,23.02015025294894,21.13937590828712,2.5358596775531277,28.71857168225681,-29.564150785875114],[-35.04453266129624,23.961954593367143,21.10454353413732,25.289620498610486,-1.3518234286889679,16.021231751153415,-1.5313278501349157,-14.144306339588473,-24.05587728113364,-0.6310829424821627,-20.22730187547018,22.6324607707043],[24.556865334018443,23.0514711940765,22.058309194283158,21.440103110203395,-1.408387199977011,-20.521247522308997,-2.9593583991563635,-14.532611463855607,-28.77806755293771,1.1322881667264317,21.025270968815484,-26.99503588861358],[7.7584654253010665,10.239397925571097,1.6384520592465364,-6.570112313074126,1.927398846626422,-3.7269525704903,0.34870457317630604,-7.471710727791229,5.021996147038518,-1.952256870243599,-5.615222365595387,3.8942143597865715]],
            "bias_hidden_layer": [-7.866879993729436,-4.845273689686368,-9.18207843012388,6.332289200620433,12.338830862091719,8.196794697292912,-6.244055367663034,-5.859098776425264,-7.700134526860949,-3.781786181611518,6.022592376013554,-9.773657648453018],
            "bias_output_layer": [17.599080837989142,0.9628167161055764,10.51686608489197,10.389311767280544,-15.910724403132166,-17.537433628773385,-24.75087290582725,-26.055310566085875,44.352390533525025]
        };

        const reactiveAiWeights = {
            "W_hidden_input": [ [49.883014951616495, 57.59245484151263, -0.672577288078086, -4.988903375386864, -4.2386723787104765, -0.3802829464326487, -51.52614743053423, -59.20616069082931, -0.4303144400709679, -0.836430769864361], [1.2544896487429547, 197.73535324613735, 0.7665678664574481, -4.658991689623148, -1.0275278197147089, -0.3451168247239438, -0.5776360566089656, -196.62893288854255, 0.4268622957960812, 2.178145258677974], [-179.34087472924793, 0.7910683310065308, 0.430917659025812, -2.138491954795344, -0.8131762181423372, -0.0842501760791633, 179.23931157143116, -0.33218877304350536, 0.7374233388982616, 2.182871844878219], [-1.8856184881515037, -199.36124730962808, 0.5161760026018247, 0.8775234365777097, -0.40272117552745673, -0.29177826813695046, 0.8619607268262148, 198.7478854316389, 0.7309280007671577, 2.8834162453359533], [-22.76439364124033, 32.17873733260302, 0.4494440089348593, 0.86188829294182, -0.5152416406545638, -0.4242219259814442, 23.772702979567274, -34.243764859067944, -0.4699325899500329, -0.9306503029856132], [71.72902797518802, -24.642572101036187, -1.1887620290793939, -9.351780622359469, 0.6552540092697473, -0.32683117663651295, -72.30544470588285, 25.441351774131114, 0.3086879060488837, -0.07668660919595624], [-75.86308235675678, -0.4165895490075364, -0.36244775911148897, 6.424601071087086, 0.11621691470307739, 0.1961613556401925, 77.37544032562543, 0.4532437288454668, -0.44616262736535484, -0.02955419470821464], [-44.33606741514581, -19.108908886658078, -1.296419481874001, -2.465958212038669, -0.9609409249957751, 0.5266627547411857, 45.25354336023601, 19.976748008530606, -0.6104460885759498, -0.9186865318481638], [-0.07804077496242733, 72.51280099061795, 0.309984489766807, -1.8185226406625477, -8.006314338310663, 0.2903906843349179, 0.5356594697151632, -73.47338763597504, -0.20072560919587434, 0.2319115189972271], [-72.32539836751404, -0.3343070772493475, -1.8389759473381462, 6.595825855476627, -1.2525681143986411, 0.34575120274392274, 73.56232473229731, 0.4193739100963286, 0.29670967561504874, -0.21442011244565481], [-0.9788612006634587, 74.66218463818542, -0.49469581705441, -0.6590369155086644, -9.513810909502904, -0.03753540020625136, 1.6356985209351431, -75.58997750201836, 0.23132947532264617, 0.03111452879686536], [177.40195941476367, 0.4658773873903743, -0.03260172414886233, -0.14706310353610588, 2.705154523570634, -0.4361935311142867, -175.90573614815588, -0.31561629942845354, 0.7062683125035957, 2.003598337173347] ],
            "W_hidden_output": [ [7.650137811102573, 28.039404897503236, 5.0034281208843385, -24.915143573287367, 4.677286371179467, -1.487087071416732, 5.06121575294785, -12.895009491290573, 29.186388229157316, 4.785865184266846, 36.691571141105015, -0.9434390301118122], [-15.660898726172736, -21.008240162682576, 4.730941334452439, 47.51327273551138, -14.753165188227344, 3.2486474605984865, 5.22647463761581, 3.98988568113515, -36.130306788678475, 3.3454049009746254, -36.92460563482108, 0.9537553603313668], [-21.833426872651277, 6.048561276690666, 25.639180582303258, -1.820268485990384, 2.2617664098800105, -34.92158181162808, 35.37173610720054, 11.328544932427679, 5.589795440778212, 29.46619605343566, 5.466222801563043, -26.179762549460573], [7.994094300954188, 6.681789527074746, -23.08051216755152, -1.707366164383075, -8.41021106899765, 23.133544616209996, -41.70796509379141, -13.739103894228753, 4.385943529363188, -38.60011788859233, 3.2122653157480046, 38.716280501162245], [23.312763280984324, 13.77809114628942, -23.553490194543464, -24.743661569690733, 15.763452365600887, 10.922073759428292, -34.09078127136063, -11.427430496838147, 26.113541312072364, -29.681499101416666, 26.15043563723784, 16.879148097042386], [1.3783837853670664, 6.423182230147775, 10.611481172902202, -27.92694051878354, 13.315134531616, -35.44042196900921, 32.815405223856835, 7.909043065128791, 21.457738193267463, 26.09343817837487, 26.61145860257584, -26.093243972085954], [9.04470032104336, -23.4236592621641, -25.312418879770092, 21.758786775896613, -10.08852907455972, 37.191439037956776, -37.582669029770706, 4.477255457845394, -25.267907761399524, -26.665544267739953, -37.4118193430129, 24.865196663899045], [-13.31186254876307, -23.273537271180807, 20.195651546093753, 14.550994272356446, 1.5106204021670486, -3.672663489939727, 29.813102077792617, 12.9468136233758, -30.259023400757105, 27.76952817779629, -29.44378473313456, -28.714418230692747], [1.286665549347282, 6.844193227729, 5.26477226576454, -1.2665222266506841, -4.3434847899240205, 1.2258976748809034, 4.359527843784567, -2.966274821403714, 5.032895245242552, 3.524508391638244, 4.445331690009612, 0.02080533042381761] ],
            "bias_hidden_layer": [ -2.913724227435055, 8.328774311785176, 7.425425302056666, 9.13007413512143, -3.4522185471722, -1.0488531150680735, -0.30488423849029017, -3.531655346753246, -0.32404635922167496, -0.8835942537962942, -0.4982426907201811, 7.222518210125931 ],
            "bias_output_layer": [ -12.351024406230424, 15.246097293490882, -12.596266190459254,5.1377601306218645, -17.268595941335423, -18.755523209832344,-7.7121866279750435, -6.364670404957435, 54.35301385652795 ]
        };

        const actions = ['up', 'down', 'left', 'right', 'up-right', 'up-left', 'down-right', 'down-left', 'none'];

        const gameAreaSize = { width:1.8, height:1.8, depth:1.8 };
        const paddleZ = -0.9;


        class PaddleExperiment {
            constructor(canvas, aiWeights, label, aiType) {
                this.canvas = canvas;
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x100000);
                this.aiType = aiType;
                // Camera
                this.camera = new THREE.PerspectiveCamera(60, canvas.clientWidth/canvas.clientHeight, 0.1, 10);
                this.camera.position.set(0,0,2);
                this.camera.lookAt(0,0,0);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias:true });
                this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff,0.6);
                this.scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff,0.6);
                dirLight.position.set(1,1,2);
                this.scene.add(dirLight);

                // Game area cube
                const cubeGeom = new THREE.BoxGeometry(gameAreaSize.width, gameAreaSize.height, gameAreaSize.depth);
                const cubeMat = new THREE.MeshBasicMaterial({ color:0x00fff0, wireframe:true, transparent:true, opacity:0.3 });
                this.gameArea = new THREE.Mesh(cubeGeom,cubeMat);
                this.scene.add(this.gameArea);

                // Ball
                const ballGeom = new THREE.SphereGeometry(0.05,16,16);
                const ballMat = new THREE.MeshLambertMaterial({ color:0xff4444 });
                this.ball = new THREE.Mesh(ballGeom, ballMat);
                this.scene.add(this.ball);

                // Paddle
                const paddleGeom = new THREE.BoxGeometry(0.3,0.3,0.02);
                const paddleMat = new THREE.MeshLambertMaterial({ color:0x4444ff });
                this.paddle = new THREE.Mesh(paddleGeom, paddleMat);
                this.paddle.position.z = paddleZ;
                this.scene.add(this.paddle);

                // Intercept point
                const interceptGeom = new THREE.SphereGeometry(0.03,8,8);
                const interceptMat = new THREE.MeshBasicMaterial({ color:0xffff00, transparent:true, opacity:0.7 });
                this.intercept = new THREE.Mesh(interceptGeom, interceptMat);
                this.intercept.position.z = paddleZ;
                this.scene.add(this.intercept);

                // AI
                if (aiType === 'predictive')
                    this.ai = new predictive_model(0.1, aiWeights);
                else if (aiType === 'reactive')
                    this.ai = new reactive_model(0.1, aiWeights);
                else
                    console.log(`Invalid AI type: ${aiType}`);
                // State
                this.ballState = { X_pos:0, Y_pos:0, Z_pos:0.8, Vx:0.02, Vy:0.015, Vz:-0.03 };
                this.paddleState = { X_paddle:0, Y_paddle:0, paddle_speed:0.01, paddle_width:0.3, paddle_height:0.3 };
                this.score = 0;
                this.misses = 0;
                this.isRunning = false;
                this.label = label;

                // Stats container
                this.statsElem = document.getElementById(label);
                if(this.statsElem) this.updateStats();
            }

            updateStats(action, intercept = {x: 0, y: 0}) {
                if (!this.statsElem) return;
                this.statsElem.querySelector(".ballPos").textContent =
                    `${this.ballState.X_pos.toFixed(2)}, ${this.ballState.Y_pos.toFixed(2)}, ${this.ballState.Z_pos.toFixed(2)}`;
                this.statsElem.querySelector(".ballVel").textContent =
                    `${this.ballState.Vx.toFixed(3)}, ${this.ballState.Vy.toFixed(3)}, ${this.ballState.Vz.toFixed(3)}`;
                this.statsElem.querySelector(".paddlePos").textContent =
                    `${this.paddleState.X_paddle.toFixed(2)}, ${this.paddleState.Y_paddle.toFixed(2)}`;
                this.statsElem.querySelector(".aiAction").textContent = action;
                this.statsElem.querySelector(".intercept").textContent =
                    `${intercept.x.toFixed(2)}, ${intercept.y.toFixed(2)}`;
                this.statsElem.querySelector(".score").textContent = this.score;
                this.statsElem.querySelector(".misses").textContent = this.misses;
            }

            predictIntercept(X_pos, Y_pos, Z_pos, Vx, Vy, Vz) {
                let x = X_pos, y = Y_pos, z = Z_pos;
                let vx = Vx, vy = Vy, vz = Vz;

                let iterations = 0;
                const maxIterations = 100;

                while (iterations < maxIterations) {
                    if (vz >= 0 || z <= paddleZ) return { x, y };

                    const t = (paddleZ - z) / vz;

                    // Time to hit walls
                    let tx = Infinity, ty = Infinity;
                    if (vx > 0) tx = (gameAreaSize.width / 2 - x) / vx;
                    else if (vx < 0) tx = (-gameAreaSize.width / 2 - x) / vx;
                    if (vy > 0) ty = (gameAreaSize.height / 2 - y) / vy;
                    else if (vy < 0) ty = (-gameAreaSize.height / 2 - y) / vy;

                    const tWall = Math.min(tx, ty);

                    if (t < tWall) {
                        return { x: x + vx * t, y: y + vy * t };
                    } else {
                        if (tx < ty) {
                            x += vx * tx; y += vy * tx; z += vz * tx;
                            vx *= -1;
                        } else {
                            x += vx * ty; y += vy * ty; z += vz * ty;
                            vy *= -1;
                        }
                    }
                    iterations++;
                }

                return { x, y };
            }

            getAIState(intercept) {
                const { X_pos, Y_pos, Z_pos, Vx, Vy, Vz } = this.ballState;
                const { X_paddle, Y_paddle, paddle_speed, paddle_height } = this.paddleState;

                if (this.aiType === 'predictive') {
                    const dx = intercept.x - X_paddle;
                    const dy = intercept.y - Y_paddle;

                    return {
                        X_pos, Y_pos, Z_pos, Vx, Vy, Vz,
                        X_paddle, Y_paddle, paddle_speed, paddle_height,
                        time_to_wall_x: Math.min(Math.max(((Vx > 0 ? gameAreaSize.width/2 - X_pos : -gameAreaSize.width/2 - X_pos) / Vx)/50, 0), 1),
                        time_to_wall_y: Math.min(Math.max(((Vy > 0 ? gameAreaSize.height/2 - Y_pos : -gameAreaSize.height/2 - Y_pos) / Vy)/50, 0), 1),
                        x_dist_to_paddle: dx / gameAreaSize.width,
                        y_dist_to_paddle: dy / gameAreaSize.height
                    };
                } else {
                    return { X_pos, Y_pos, Z_pos, 
                             Vx, Vy, Vz, 
                             X_paddle, Y_paddle, 
                             paddle_speed, paddle_height };
                }
            }

            resize() {
                const width = this.canvas.clientWidth;
                const height = this.canvas.clientHeight;
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            updateSimulation() {
                if (!this.isRunning) return;
                const maxTime = 50;
                const intercept = this.predictIntercept(this.ballState.X_pos, this.ballState.Y_pos, this.ballState.Z_pos, 
                                        this.ballState.Vx, this.ballState.Vy, this.ballState.Vz);
                // Create state for AI
                const aiState = this.getAIState(intercept);
                const action = this.ai.predict(aiState);

                // Move paddle based on AI action
                switch (action) {
                    case 'up': this.paddleState.Y_paddle += this.paddleState.paddle_speed; break;
                    case 'down': this.paddleState.Y_paddle -= this.paddleState.paddle_speed; break;
                    case 'left': this.paddleState.X_paddle -= this.paddleState.paddle_speed; break;
                    case 'right': this.paddleState.X_paddle += this.paddleState.paddle_speed; break;
                    case 'up-right': 
                        this.paddleState.Y_paddle += this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle += this.paddleState.paddle_speed; 
                        break;
                    case 'up-left': 
                        this.paddleState.Y_paddle += this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle -= this.paddleState.paddle_speed; 
                        break;
                    case 'down-right': 
                        this.paddleState.Y_paddle -= this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle += this.paddleState.paddle_speed; 
                        break;
                    case 'down-left': 
                        this.paddleState.Y_paddle -= this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle -= this.paddleState.paddle_speed; 
                        break;
                }

                // Constrain paddle to game area
                this.paddleState.X_paddle = Math.max(-gameAreaSize.width/2 + this.paddleState.paddle_width/2, 
                                            Math.min(gameAreaSize.width/2 - this.paddleState.paddle_width/2, this.paddleState.X_paddle));
                this.paddleState.Y_paddle = Math.max(-gameAreaSize.height/2 + this.paddleState.paddle_height/2, 
                                            Math.min(gameAreaSize.height/2 - this.paddleState.paddle_height/2, this.paddleState.Y_paddle));

                // Move ball
                this.ballState.X_pos += this.ballState.Vx;
                this.ballState.Y_pos += this.ballState.Vy;
                this.ballState.Z_pos += this.ballState.Vz;

                // Ball bouncing off walls (X and Y walls bounce, Z walls have different behavior)
                if (this.ballState.X_pos < -gameAreaSize.width / 2 || this.ballState.X_pos > gameAreaSize.width / 2) {
                    this.ballState.Vx *= -1;
                    this.ballState.X_pos = Math.max(Math.min(this.ballState.X_pos, gameAreaSize.width / 2), -gameAreaSize.width / 2);
                }
                if (this.ballState.Y_pos < -gameAreaSize.height / 2 || this.ballState.Y_pos > gameAreaSize.height / 2) {
                    this.ballState.Vy *= -1;
                    this.ballState.Y_pos = Math.max(Math.min(this.ballState.Y_pos, gameAreaSize.height / 2), -gameAreaSize.height / 2);
                }

                // Ball bouncing off front wall (opposite to AI paddle)
                if (this.ballState.Z_pos > gameAreaSize.depth / 2) {
                    this.ballState.Vz *= -1;
                    this.ballState.Z_pos = gameAreaSize.depth / 2;
                }

                // Check paddle collision
                if (this.ballState.Z_pos <= paddleZ + 0.05 && 
                    Math.abs(this.ballState.X_pos - this.paddleState.X_paddle) < this.paddleState.paddle_width / 2 &&
                    Math.abs(this.ballState.Y_pos - this.paddleState.Y_paddle) < this.paddleState.paddle_height / 2) {
                    this.ballState.Vz *= -1;
                    this.ballState.Z_pos = paddleZ + 0.05;
                    this.score++;
                }

                // Reset if ball goes too far back
                if (this.ballState.Z_pos < -1.2) {
                    this.misses++;
                    this.reset_random();
                    this.isRunning = true;
                }

                // Update 3D objects
                this.ball.position.set(this.ballState.X_pos, this.ballState.Y_pos, this.ballState.Z_pos);
                this.paddle.position.set(this.paddleState.X_paddle, this.paddleState.Y_paddle, paddleZ);
                this.intercept.position.set(intercept.x, intercept.y, paddleZ);
                this.updateStats(action, intercept);
            }

            animate() {
                requestAnimationFrame(()=>this.animate());
                this.updateSimulation();
                this.renderer.render(this.scene, this.camera);
            }

            start() { this.isRunning=true; }
            pause() { this.isRunning=false; }
            reset() {
                this.isRunning=false;
                this.ballState={ X_pos:0, Y_pos:0, Z_pos:0.8, Vx:0.02, Vy:0.015, Vz:-0.03 };
                this.paddleState={ X_paddle:0, Y_paddle:0, paddle_speed:0.015, paddle_width:0.3, paddle_height:0.3 };
                this.score=0; this.misses=0;
                this.updateStats();
            }
            reset_random() {
                this.isRunning=false;
                this.ballState.X_pos = (Math.random() - 0.5) * gameAreaSize.width * 0.5;
                this.ballState.Y_pos = (Math.random() - 0.5) * gameAreaSize.height * 0.5;
                this.ballState.Z_pos = 0.8;
                this.ballState.Vx = (Math.random() - 0.5) * 0.04;
                this.ballState.Vy = (Math.random() - 0.5) * 0.04;
                this.ballState.Vz = -0.02 - Math.random() * 0.02;
                this.paddleState={ X_paddle:0, Y_paddle:0, paddle_speed:0.015, paddle_width:0.3, paddle_height:0.3 };
                this.score=0;
                this.updateStats();
            }
    }


    document.getElementById('startBtn').addEventListener('click', () => {
        experimentLeft.start();
        experimentRight.start();
        document.getElementById('startBtn').disabled = true;
        document.getElementById('pauseBtn').disabled = false;
        document.getElementById('resetBtn').disabled = false;
    });

    // Pause
    document.getElementById('pauseBtn').addEventListener('click', () => {
        experimentLeft.pause();
        experimentRight.pause();
        document.getElementById('startBtn').disabled = false;
        document.getElementById('resetBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
    });

    document.getElementById('lessSpeed').addEventListener('click', () => {
        experimentLeft.ballState.Vx -= experimentLeft.ballState.Vx / 4;
        experimentLeft.ballState.Vy -= experimentLeft.ballState.Vy / 4;
        experimentLeft.ballState.Vz -= experimentLeft.ballState.Vz / 4;
        experimentRight.ballState.Vx -= experimentRight.ballState.Vx / 4;
        experimentRight.ballState.Vy -= experimentRight.ballState.Vy / 4;
        experimentRight.ballState.Vz -= experimentRight.ballState.Vz / 4;
    })

    document.getElementById('moreSpeed').addEventListener('click', () => {
        experimentLeft.ballState.Vx += experimentLeft.ballState.Vx / 4;
        experimentLeft.ballState.Vy += experimentLeft.ballState.Vy / 4;
        experimentLeft.ballState.Vz += experimentLeft.ballState.Vz / 4;
        experimentRight.ballState.Vx += experimentRight.ballState.Vx / 4;
        experimentRight.ballState.Vy += experimentRight.ballState.Vy / 4;
        experimentRight.ballState.Vz += experimentRight.ballState.Vz / 4;
    })

    // Reset
    document.getElementById('resetBtn').addEventListener('click', () => {
        experimentLeft.reset_random();
        experimentRight.ballState = { ...experimentLeft.ballState };
        experimentRight.paddleState = { ...experimentLeft.paddleState };
        experimentLeft.score = 0;
        experimentRight.score = 0;
        experimentLeft.misses = 0;
        experimentRight.misses = 0;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('pauseBtn').disabled = false;
        experimentLeft.start();
        experimentRight.start();
    });

    window.addEventListener('resize', () => {
        experimentLeft.resize();
        experimentRight.resize();
    });

    let mouseDown = false, mouseX = 0, mouseY = 0;

    document.addEventListener('mousedown', e => { mouseDown = true; mouseX = e.clientX; mouseY = e.clientY; });
    document.addEventListener('mouseup', () => mouseDown = false);

    document.addEventListener('mousemove', e => {
        if (!mouseDown) return;
        const deltaX = e.clientX - mouseX;
        const deltaY = e.clientY - mouseY;

        [experimentLeft.camera, experimentRight.camera].forEach(camera => {
            const spherical = new THREE.Spherical();
            spherical.setFromVector3(camera.position);
            spherical.theta -= deltaX * 0.01;
            spherical.phi += deltaY * 0.01;
            spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
            camera.position.setFromSpherical(spherical);
            camera.lookAt(0, 0, 0);
        });

        mouseX = e.clientX;
        mouseY = e.clientY;
    });

    document.addEventListener('wheel', e => {
        [experimentLeft.camera, experimentRight.camera].forEach(camera => {
            const distance = camera.position.length();
            const newDistance = Math.max(1, Math.min(10, distance + e.deltaY * 0.01));
            camera.position.normalize().multiplyScalar(newDistance);
        });
    });


    const moveStatsBtn = document.getElementById('moveStatsBtn');
    const statsContainer = document.getElementById('stats-container');

    statsContainer.style.display = 'none';
    let statsHidden = true;

    moveStatsBtn.addEventListener('click', () => {
        if (statsHidden) {
            // Show stats
            statsContainer.style.display = 'flex';
            statsContainer.style.flexDirection = 'column';
            moveStatsBtn.textContent = 'Hide Stats ↑';
        } else {
            // Hide stats
            statsContainer.style.display = 'none';
            moveStatsBtn.textContent = 'Show Stats ↓';
        }
        statsHidden = !statsHidden;
    });

    // --- Initialize left and right experiments ---
    const experimentLeft = new PaddleExperiment(document.getElementById('predictiveAI'), predictiveAiWeights, 'stats_left', 'predictive');
    const experimentRight = new PaddleExperiment(document.getElementById('reactiveAI'), reactiveAiWeights, 'stats_right', 'reactive');
    experimentLeft.animate();
    experimentRight.animate();
    experimentLeft.reset();
    experimentRight.reset();
    </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Paddle 3D Environment</title>
    <!-- <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #predictiveAI, #reactiveAI {
                flex: 1;
                height: 50%;
                width: 100%;
            }
        }

        @media (min-width: 769px) {
            #predictiveAI, #reactiveAI {
                flex: 1;
                height: 100%;
                width: 50%;
            }
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            max-width: calc(100vw - 20px);
        }

        @media (min-width: 769px) {
            #ui {
                top: 20px;
                left: 20px;
                padding: 15px;
                font-size: 14px;
            }
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-width: calc(100vw - 20px);
        }

        #controls-2 {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 100;
        }

        @media (min-width: 769px) {
            #controls, #controls-2 {
                bottom: 20px;
            }
            #controls {
                left: 20px;
            }
            #controls-2 {
                right: 20px;
            }
        }

        button {
            margin: 2px;
            padding: 8px 12px;
            background: #5387f7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            min-height: 36px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 769px) {
            button {
                margin: 5px;
                padding: 10px 15px;
                font-size: 14px;
                min-height: auto;
            }
        }

        button:hover, button:active {
            background: #3b6dd9;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .stats-container {
            position: absolute;
            top: 60px;
            left: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            max-width: calc(100vw - 20px);
        }

        @media (min-width: 769px) {
            .stats-container {
                top: 80px;
                left: 20px;
                gap: 15px;
            }
        }

        .stats-box {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
            width: 100%;
            max-width: 280px;
            pointer-events: auto;
            color: white;
        }

        @media (min-width: 769px) {
            .stats-box {
                padding: 10px;
                font-size: 14px;
                width: 220px;
            }
        }

        .ui-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.1em;
            color: white;
        }

        /* Touch-friendly improvements */
        @media (max-width: 768px) {
            /* Larger touch targets */
            button {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Better spacing for small screens */
            #ui {
                font-size: 11px;
                line-height: 1.3;
            }
            
            .stats-box {
                font-size: 10px;
                line-height: 1.4;
            }
            
            /* Stack controls better on mobile */
            #controls {
                flex-direction: row;
                align-items: flex-end;
            }
        }

        /* Prevent zoom on double tap */
        canvas {
            touch-action: pan-x pan-y;
        }

        /* Loading indicator for better UX */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 1000;
        }
    </style> -->
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #predictiveAI, #reactiveAI {
                /* flex: 1;
                height: 50vh;
                width: 100vw;
                 */
                 flex: 1;             /* distribute space equally */
                width: 100%;         /* take full width of flex item */
                height: 100%;        /* take full height of flex item */
                display: block; 
            }
        }

        @media (min-width: 769px) {
            #predictiveAI, #reactiveAI {
                flex: 1;
                height: 100vh;
                width: 50vw;
            }
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            max-width: calc(100vw - 20px);
        }

        @media (min-width: 769px) {
            #ui {
                top: 20px;
                left: 20px;
                padding: 15px;
                font-size: 14px;
            }
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-width: calc(100vw - 20px);
        }

        #controls-2 {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 100;
        }

        @media (min-width: 769px) {
            #controls, #controls-2 {
                bottom: 20px;
            }
            #controls {
                left: 20px;
            }
            #controls-2 {
                right: 20px;
            }
        }

        button {
            margin: 2px;
            padding: 8px 12px;
            background: #5387f7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            min-height: 36px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 769px) {
            button {
                margin: 5px;
                padding: 10px 15px;
                font-size: 14px;
                min-height: auto;
            }
        }

        button:hover, button:active {
            background: #3b6dd9;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .stats-container {
            position: absolute;
            top: 60px;
            left: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            max-width: calc(100vw - 20px);
        }

        @media (min-width: 769px) {
            .stats-container {
                top: 80px;
                left: 20px;
                gap: 15px;
            }
        }

        .stats-box {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
            width: 100%;
            max-width: 280px;
            pointer-events: auto;
            color: white;
        }

        @media (min-width: 769px) {
            .stats-box {
                padding: 10px;
                font-size: 14px;
                width: 220px;
            }
        }

        .ui-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.1em;
            color: white;
        }

        /* Touch-friendly improvements */
        @media (max-width: 768px) {
            /* Larger touch targets */
            button {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Better spacing for small screens */
            #ui {
                font-size: 11px;
                line-height: 1.3;
            }
            
            .stats-box {
                font-size: 10px;
                line-height: 1.4;
            }
            
            /* Stack controls better on mobile */
            #controls {
                flex-direction: row;
                align-items: flex-end;
            }
        }

        /* Prevent zoom on double tap */
        canvas {
            touch-action: pan-x pan-y;
        }

        /* Loading indicator for better UX */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading AI Paddle Environment...</div>
    <div id="container">
        <canvas id="predictiveAI"></canvas>
        <canvas id="reactiveAI"></canvas>
        <div id="ui">
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <strong>AI Paddle Simulation</strong>
                <button id="moveStatsBtn">Stats ↓</button>
            </div>
            <div id="stats-container" class="stats-container">
                <div id="stats_left" class="stats-box">
                    <strong>Predictive AI (left)</strong>
                    <div>Ball Position: <span class="ballPos">0,0,0</span></div>
                    <div>Ball Velocity: <span class="ballVel">0,0,0</span></div>
                    <div>Paddle Position: <span class="paddlePos">0,0</span></div>
                    <div>AI Action: <span class="aiAction">none</span></div>
                    <div>Predicted Intercept: <span class="intercept">0,0</span></div>
                    <div>Score: <span class="score">0</span></div>
                    <div>Misses: <span class="misses">0</span></div>
                </div>

                <div id="stats_right" class="stats-box right-stats">
                    <strong>Reactive AI (right)</strong>
                    <div>Ball Position: <span class="ballPos">0,0,0</span></div>
                    <div>Ball Velocity: <span class="ballVel">0,0,0</span></div>
                    <div>Paddle Position: <span class="paddlePos">0,0</span></div>
                    <div>AI Action: <span class="aiAction">none</span></div>
                    <div>Predicted Intercept: <span class="intercept">0,0</span></div>
                    <div>Score: <span class="score">0</span></div>
                    <div>Misses: <span class="misses">0</span></div>
                </div>
            </div>
        </div>
        <div>
            <div id="controls">
                <button id="startBtn">Start</button>
                <button id="resetBtn">Reset</button>
                <button id="pauseBtn" disabled>Pause</button>
                <button id="lessSpeed">Speed -</button>
                <button id="moreSpeed">Speed +</button>
            </div>
            <div id="controls-2">
                <a id="documentation" href="documentation.html">
                    <button>Docs</button>
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';
        import { predictive_model } from './dist/predictive_model.js';
        import { reactive_model } from './dist/reactive_model.js';

        // Hide loading indicator once scripts are loaded
        document.getElementById('loading').style.display = 'none';

        const predictiveAiWeights = {
            "W_hidden_input": [[0.07571163054980735,-0.09879728658770932,-0.0025411196896264507,1.2834025446819128,-1.4762437387130491,-2.0096605239446923,-0.04497989174719303,0.14464276705798085,-0.14384152071922535,-2.6871606026881096,-0.037192423671404184,0.02891691912057464,-311.3089085534629,0.22422554934879174],[-0.055908044001824246,0.17897313214296667,0.019693933411955793,-0.5555207873771879,2.2761658471179262,0.4055828201728979,0.08063808511155879,-0.05247733265746928,0.18930662438179605,-1.3870115399946836,0.10819959396504145,-0.17703519849842672,0.21735121993685436,-189.5703621437401],[-0.11996995608546475,-0.16821818278725512,-0.026514615265630273,0.520352123122718,-1.3549415695435347,-2.9536055627943325,0.15578515626907521,-0.0031034380345209,-0.25930133582777615,-2.439842863941628,0.005400387386199475,0.13899807600698164,0.011086514603524996,-344.7379207044564],[0.7236220416763963,-0.7871593103401202,-0.24919496022967125,1.9015394668118888,-3.5155533070112055,2.6854562433555818,-0.6834962795564965,0.679048354753963,0.26495820359637,1.7243039339691388,0.27930093887360574,-0.5971802296707363,-2.471654659060362,-245.94307039350815],[-2.019671960006264,-0.4552554572845688,15.809793749060773,-4.979472406891216,-0.6555166883461876,-1.5327924331613594,2.062761900500206,-0.47765952031314085,0.6138937109126485,3.601799382496622,-0.1811326547677063,1.2113076421581033,-1.2295364922849528,2.3901557464885883],[0.25728658284217976,-0.022569852547878164,0.01915896336102582,2.292436855209007,-2.0371010602550226,1.8217104475416137,-0.138520495181266,0.030168343696500587,0.050822933268802196,1.9486108885543594,-0.17303163095891064,-0.0782311195475366,306.533478053833,0.6168269323406569],[-5.077476498576406,-3.783217007223332,0.508926921028604,8.177646077753312,-15.211351776485696,-0.876980750720473,4.252700487941269,1.266400102200764,-0.24846508983015184,-1.5981345783902479,0.6658633679768005,-4.4944315300882645,-6.0136894879371585,-2.8451471648701805],[0.2813295759387656,-0.23039634610601592,-0.20863415124998796,0.8625718396842388,-2.207002890024836,1.8799220975780464,-0.18053700863124647,0.13890810093255304,0.1770980915304153,-1.5416157760064633,0.1305220551356998,-0.1868867783268398,-0.05468156885394678,257.73787489774804],[-0.1291139150396751,-0.305971056100352,0.1848967650463433,-0.9415930364495617,1.880637367153625,-2.7239235222535947,0.03905840076017982,0.26416629828739535,-0.6437493151592494,-2.29718676163057,0.009946265957835017,0.0650425471060561,-0.5048016679176428,310.5769867828448],[3.0700962227538042,-2.240844280894971,9.652366144098082,-3.319920397073904,8.98419295367224,1.7142406779904562,-2.0252012396690495,-0.5955949335514298,-0.43274840924580144,-1.2694721763951071,-2.200798866694345,-0.32225619585529414,-5.573865701783698,7.5583317441730244],[0.11709059555324605,0.015467543734551415,-0.11442797399781522,-0.7890912398098265,1.3026122649321992,0.6166225733936866,0.03572383519838623,0.0935330428667419,0.6847475335566203,2.192350259882323,-0.12751882887273813,-0.000010840398174364866,-242.5461858393826,-0.03143053740709588],[0.08643936911585474,-0.003811546995645865,0.03134681026362951,-0.14102672668016178,0.7927377534217558,-2.8904705355734923,-0.013111737220672128,0.02185929231092091,-0.7864752325199064,-2.537558240318566,-0.010260937499850433,0.035806261857610475,379.0260097205163,-0.13087664108676106]],
            "W_hidden_output": [[8.441808794552111,-33.106030509716355,-21.910602347630284,-17.47655220581277,1.4383373729040745,-2.8756694985605007,0.7861629352794715,23.14513560564827,20.08447300246348,0.8163995900382018,-4.443163801062265,4.9535036976720885],[7.082982023238169,23.189538835820464,22.016210299696944,24.647903965171082,-0.24541110379151537,-4.406583997731274,-2.633629656321939,-18.02046733969284,-26.107482393495346,-1.106158706196698,-8.11906188272826,1.8450016051976486],[24.852681997262536,9.760592782394216,2.347784046223444,-5.8702280410649585,0.8337743742011335,-19.819306929545693,-1.5417711161069945,-7.825156505412876,6.641781982768545,-0.37197338899338256,26.797266816568367,-26.419180660802475],[-29.836484427635774,9.462268838534634,2.107105164835105,-6.188779657307045,0.14096064612022308,26.180098625362263,0.7662680640213225,-7.1348598246391886,5.391174754373744,-1.6207106304265115,-18.891850162791883,24.124549454167685],[-35.28632183498873,-31.401234866694974,-22.62465299366761,-16.811778271777314,-0.14685252083972575,26.855185215353004,1.7583029840702484,23.46334737709763,21.1435577907907,1.1009595997362445,-18.79395150038529,24.63242186481537],[26.66201645505108,-35.690215393483186,-27.17615090761119,-17.640152875296618,-0.3262412124472861,-19.121904398266935,4.102492019689961,23.02015025294894,21.13937590828712,2.5358596775531277,28.71857168225681,-29.564150785875114],[-35.04453266129624,23.961954593367143,21.10454353413732,25.289620498610486,-1.3518234286889679,16.021231751153415,-1.5313278501349157,-14.144306339588473,-24.05587728113364,-0.6310829424821627,-20.22730187547018,22.6324607707043],[24.556865334018443,23.0514711940765,22.058309194283158,21.440103110203395,-1.408387199977011,-20.521247522308997,-2.9593583991563635,-14.532611463855607,-28.77806755293771,1.1322881667264317,21.025270968815484,-26.99503588861358],[7.7584654253010665,10.239397925571097,1.6384520592465364,-6.570112313074126,1.927398846626422,-3.7269525704903,0.34870457317630604,-7.471710727791229,5.021996147038518,-1.952256870243599,-5.615222365595387,3.8942143597865715]],
            "bias_hidden_layer": [-7.866879993729436,-4.845273689686368,-9.18207843012388,6.332289200620433,12.338830862091719,8.196794697292912,-6.244055367663034,-5.859098776425264,-7.700134526860949,-3.781786181611518,6.022592376013554,-9.773657648453018],
            "bias_output_layer": [17.599080837989142,0.9628167161055764,10.51686608489197,10.389311767280544,-15.910724403132166,-17.537433628773385,-24.75087290582725,-26.055310566085875,44.352390533525025]
        };

        const reactiveAiWeights = {
            "W_hidden_input": [ [49.883014951616495, 57.59245484151263, -0.672577288078086, -4.988903375386864, -4.2386723787104765, -0.3802829464326487, -51.52614743053423, -59.20616069082931, -0.4303144400709679, -0.836430769864361], [1.2544896487429547, 197.73535324613735, 0.7665678664574481, -4.658991689623148, -1.0275278197147089, -0.3451168247239438, -0.5776360566089656, -196.62893288854255, 0.4268622957960812, 2.178145258677974], [-179.34087472924793, 0.7910683310065308, 0.430917659025812, -2.138491954795344, -0.8131762181423372, -0.0842501760791633, 179.23931157143116, -0.33218877304350536, 0.7374233388982616, 2.182871844878219], [-1.8856184881515037, -199.36124730962808, 0.5161760026018247, 0.8775234365777097, -0.40272117552745673, -0.29177826813695046, 0.8619607268262148, 198.7478854316389, 0.7309280007671577, 2.8834162453359533], [-22.76439364124033, 32.17873733260302, 0.4494440089348593, 0.86188829294182, -0.5152416406545638, -0.4242219259814442, 23.772702979567274, -34.243764859067944, -0.4699325899500329, -0.9306503029856132], [71.72902797518802, -24.642572101036187, -1.1887620290793939, -9.351780622359469, 0.6552540092697473, -0.32683117663651295, -72.30544470588285, 25.441351774131114, 0.3086879060488837, -0.07668660919595624], [-75.86308235675678, -0.4165895490075364, -0.36244775911148897, 6.424601071087086, 0.11621691470307739, 0.1961613556401925, 77.37544032562543, 0.4532437288454668, -0.44616262736535484, -0.02955419470821464], [-44.33606741514581, -19.108908886658078, -1.296419481874001, -2.465958212038669, -0.9609409249957751, 0.5266627547411857, 45.25354336023601, 19.976748008530606, -0.6104460885759498, -0.9186865318481638], [-0.07804077496242733, 72.51280099061795, 0.309984489766807, -1.8185226406625477, -8.006314338310663, 0.2903906843349179, 0.5356594697151632, -73.47338763597504, -0.20072560919587434, 0.2319115189972271], [-72.32539836751404, -0.3343070772493475, -1.8389759473381462, 6.595825855476627, -1.2525681143986411, 0.34575120274392274, 73.56232473229731, 0.4193739100963286, 0.29670967561504874, -0.21442011244565481], [-0.9788612006634587, 74.66218463818542, -0.49469581705441, -0.6590369155086644, -9.513810909502904, -0.03753540020625136, 1.6356985209351431, -75.58997750201836, 0.23132947532264617, 0.03111452879686536], [177.40195941476367, 0.4658773873903743, -0.03260172414886233, -0.14706310353610588, 2.705154523570634, -0.4361935311142867, -175.90573614815588, -0.31561629942845354, 0.7062683125035957, 2.003598337173347] ],
            "W_hidden_output": [ [7.650137811102573, 28.039404897503236, 5.0034281208843385, -24.915143573287367, 4.677286371179467, -1.487087071416732, 5.06121575294785, -12.895009491290573, 29.186388229157316, 4.785865184266846, 36.691571141105015, -0.9434390301118122], [-15.660898726172736, -21.008240162682576, 4.730941334452439, 47.51327273551138, -14.753165188227344, 3.2486474605984865, 5.22647463761581, 3.98988568113515, -36.130306788678475, 3.3454049009746254, -36.92460563482108, 0.9537553603313668], [-21.833426872651277, 6.048561276690666, 25.639180582303258, -1.820268485990384, 2.2617664098800105, -34.92158181162808, 35.37173610720054, 11.328544932427679, 5.589795440778212, 29.46619605343566, 5.466222801563043, -26.179762549460573], [7.994094300954188, 6.681789527074746, -23.08051216755152, -1.707366164383075, -8.41021106899765, 23.133544616209996, -41.70796509379141, -13.739103894228753, 4.385943529363188, -38.60011788859233, 3.2122653157480046, 38.716280501162245], [23.312763280984324, 13.77809114628942, -23.553490194543464, -24.743661569690733, 15.763452365600887, 10.922073759428292, -34.09078127136063, -11.427430496838147, 26.113541312072364, -29.681499101416666, 26.15043563723784, 16.879148097042386], [1.3783837853670664, 6.423182230147775, 10.611481172902202, -27.92694051878354, 13.315134531616, -35.44042196900921, 32.815405223856835, 7.909043065128791, 21.457738193267463, 26.09343817837487, 26.61145860257584, -26.093243972085954], [9.04470032104336, -23.4236592621641, -25.312418879770092, 21.758786775896613, -10.08852907455972, 37.191439037956776, -37.582669029770706, 4.477255457845394, -25.267907761399524, -26.665544267739953, -37.4118193430129, 24.865196663899045], [-13.31186254876307, -23.273537271180807, 20.195651546093753, 14.550994272356446, 1.5106204021670486, -3.672663489939727, 29.813102077792617, 12.9468136233758, -30.259023400757105, 27.76952817779629, -29.44378473313456, -28.714418230692747], [1.286665549347282, 6.844193227729, 5.26477226576454, -1.2665222266506841, -4.3434847899240205, 1.2258976748809034, 4.359527843784567, -2.966274821403714, 5.032895245242552, 3.524508391638244, 4.445331690009612, 0.02080533042381761] ],
            "bias_hidden_layer": [ -2.913724227435055, 8.328774311785176, 7.425425302056666, 9.13007413512143, -3.4522185471722, -1.0488531150680735, -0.30488423849029017, -3.531655346753246, -0.32404635922167496, -0.8835942537962942, -0.4982426907201811, 7.222518210125931 ],
            "bias_output_layer": [ -12.351024406230424, 15.246097293490882, -12.596266190459254,5.1377601306218645, -17.268595941335423, -18.755523209832344,-7.7121866279750435, -6.364670404957435, 54.35301385652795 ]
        };

        const actions = ['up', 'down', 'left', 'right', 'up-right', 'up-left', 'down-right', 'down-left', 'none'];
        const gameAreaSize = { width:1.8, height:1.8, depth:1.8 };
        const paddleZ = -0.9;

        class PaddleExperiment {
            constructor(canvas, aiWeights, label, aiType) {
                this.canvas = canvas;
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x100000);
                this.aiType = aiType;
                
                // Camera
                this.camera = new THREE.PerspectiveCamera(60, canvas.clientWidth/canvas.clientHeight, 0.1, 10);
                this.camera.position.set(0,0,2);
                this.camera.lookAt(0,0,0);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias:true });
                this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff,0.6);
                this.scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff,0.6);
                dirLight.position.set(1,1,2);
                this.scene.add(dirLight);

                // Game area cube
                const cubeGeom = new THREE.BoxGeometry(gameAreaSize.width, gameAreaSize.height, gameAreaSize.depth);
                const cubeMat = new THREE.MeshBasicMaterial({ color:0x00fff0, wireframe:true, transparent:true, opacity:0.3 });
                this.gameArea = new THREE.Mesh(cubeGeom,cubeMat);
                this.scene.add(this.gameArea);

                // Ball
                const ballGeom = new THREE.SphereGeometry(0.05,16,16);
                const ballMat = new THREE.MeshLambertMaterial({ color:0xff4444 });
                this.ball = new THREE.Mesh(ballGeom, ballMat);
                this.scene.add(this.ball);

                // Paddle
                const paddleGeom = new THREE.BoxGeometry(0.3,0.3,0.02);
                const paddleMat = new THREE.MeshLambertMaterial({ color:0x4444ff });
                this.paddle = new THREE.Mesh(paddleGeom, paddleMat);
                this.paddle.position.z = paddleZ;
                this.scene.add(this.paddle);

                // Intercept point
                const interceptGeom = new THREE.SphereGeometry(0.03,8,8);
                const interceptMat = new THREE.MeshBasicMaterial({ color:0xffff00, transparent:true, opacity:0.7 });
                this.intercept = new THREE.Mesh(interceptGeom, interceptMat);
                this.intercept.position.z = paddleZ;
                this.scene.add(this.intercept);

                // AI
                if (aiType === 'predictive')
                    this.ai = new predictive_model(0.1, aiWeights);
                else if (aiType === 'reactive')
                    this.ai = new reactive_model(0.1, aiWeights);
                else
                    console.log(`Invalid AI type: ${aiType}`);
                    
                // State
                this.ballState = { X_pos:0, Y_pos:0, Z_pos:0.8, Vx:0.02, Vy:0.015, Vz:-0.03 };
                this.paddleState = { X_paddle:0, Y_paddle:0, paddle_speed:0.01, paddle_width:0.3, paddle_height:0.3 };
                this.score = 0;
                this.misses = 0;
                this.isRunning = false;
                this.label = label;

                // Stats container
                this.statsElem = document.getElementById(label);
                if(this.statsElem) this.updateStats();
            }

            updateStats(action, intercept = {x: 0, y: 0}) {
                if (!this.statsElem) return;
                this.statsElem.querySelector(".ballPos").textContent =
                    `${this.ballState.X_pos.toFixed(2)}, ${this.ballState.Y_pos.toFixed(2)}, ${this.ballState.Z_pos.toFixed(2)}`;
                this.statsElem.querySelector(".ballVel").textContent =
                    `${this.ballState.Vx.toFixed(3)}, ${this.ballState.Vy.toFixed(3)}, ${this.ballState.Vz.toFixed(3)}`;
                this.statsElem.querySelector(".paddlePos").textContent =
                    `${this.paddleState.X_paddle.toFixed(2)}, ${this.paddleState.Y_paddle.toFixed(2)}`;
                this.statsElem.querySelector(".aiAction").textContent = action;
                this.statsElem.querySelector(".intercept").textContent =
                    `${intercept.x.toFixed(2)}, ${intercept.y.toFixed(2)}`;
                this.statsElem.querySelector(".score").textContent = this.score;
                this.statsElem.querySelector(".misses").textContent = this.misses;
            }

            predictIntercept(X_pos, Y_pos, Z_pos, Vx, Vy, Vz) {
                let x = X_pos, y = Y_pos, z = Z_pos;
                let vx = Vx, vy = Vy, vz = Vz;

                let iterations = 0;
                const maxIterations = 100;

                while (iterations < maxIterations) {
                    if (vz >= 0 || z <= paddleZ) return { x, y };

                    const t = (paddleZ - z) / vz;

                    // Time to hit walls
                    let tx = Infinity, ty = Infinity;
                    if (vx > 0) tx = (gameAreaSize.width / 2 - x) / vx;
                    else if (vx < 0) tx = (-gameAreaSize.width / 2 - x) / vx;
                    if (vy > 0) ty = (gameAreaSize.height / 2 - y) / vy;
                    else if (vy < 0) ty = (-gameAreaSize.height / 2 - y) / vy;

                    const tWall = Math.min(tx, ty);

                    if (t < tWall) {
                        return { x: x + vx * t, y: y + vy * t };
                    } else {
                        if (tx < ty) {
                            x += vx * tx; y += vy * tx; z += vz * tx;
                            vx *= -1;
                        } else {
                            x += vx * ty; y += vy * ty; z += vz * ty;
                            vy *= -1;
                        }
                    }
                    iterations++;
                }

                return { x, y };
            }

            getAIState(intercept) {
                const { X_pos, Y_pos, Z_pos, Vx, Vy, Vz } = this.ballState;
                const { X_paddle, Y_paddle, paddle_speed, paddle_height } = this.paddleState;

                if (this.aiType === 'predictive') {
                    const dx = intercept.x - X_paddle;
                    const dy = intercept.y - Y_paddle;

                    return {
                        X_pos, Y_pos, Z_pos, Vx, Vy, Vz,
                        X_paddle, Y_paddle, paddle_speed, paddle_height,
                        time_to_wall_x: Math.min(Math.max(((Vx > 0 ? gameAreaSize.width/2 - X_pos : -gameAreaSize.width/2 - X_pos) / Vx)/50, 0), 1),
                        time_to_wall_y: Math.min(Math.max(((Vy > 0 ? gameAreaSize.height/2 - Y_pos : -gameAreaSize.height/2 - Y_pos) / Vy)/50, 0), 1),
                        x_dist_to_paddle: dx / gameAreaSize.width,
                        y_dist_to_paddle: dy / gameAreaSize.height
                    };
                } else {
                    return { X_pos, Y_pos, Z_pos, 
                             Vx, Vy, Vz, 
                             X_paddle, Y_paddle, 
                             paddle_speed, paddle_height };
                }
            }

            resize() {
                const width = this.canvas.clientWidth;
                const height = this.canvas.clientHeight;
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            updateSimulation() {
                if (!this.isRunning) return;
                const maxTime = 50;
                const intercept = this.predictIntercept(this.ballState.X_pos, this.ballState.Y_pos, this.ballState.Z_pos, 
                                        this.ballState.Vx, this.ballState.Vy, this.ballState.Vz);
                // Create state for AI
                const aiState = this.getAIState(intercept);
                const action = this.ai.predict(aiState);

                // Move paddle based on AI action
                switch (action) {
                    case 'up': this.paddleState.Y_paddle += this.paddleState.paddle_speed; break;
                    case 'down': this.paddleState.Y_paddle -= this.paddleState.paddle_speed; break;
                    case 'left': this.paddleState.X_paddle -= this.paddleState.paddle_speed; break;
                    case 'right': this.paddleState.X_paddle += this.paddleState.paddle_speed; break;
                    case 'up-right': 
                        this.paddleState.Y_paddle += this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle += this.paddleState.paddle_speed; 
                        break;
                    case 'up-left': 
                        this.paddleState.Y_paddle += this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle -= this.paddleState.paddle_speed; 
                        break;
                    case 'down-right': 
                        this.paddleState.Y_paddle -= this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle += this.paddleState.paddle_speed; 
                        break;
                    case 'down-left': 
                        this.paddleState.Y_paddle -= this.paddleState.paddle_speed; 
                        this.paddleState.X_paddle -= this.paddleState.paddle_speed; 
                        break;
                }

                // Constrain paddle to game area
                this.paddleState.X_paddle = Math.max(-gameAreaSize.width/2 + this.paddleState.paddle_width/2, 
                                            Math.min(gameAreaSize.width/2 - this.paddleState.paddle_width/2, this.paddleState.X_paddle));
                this.paddleState.Y_paddle = Math.max(-gameAreaSize.height/2 + this.paddleState.paddle_height/2, 
                                            Math.min(gameAreaSize.height/2 - this.paddleState.paddle_height/2, this.paddleState.Y_paddle));

                // Move ball
                this.ballState.X_pos += this.ballState.Vx;
                this.ballState.Y_pos += this.ballState.Vy;
                this.ballState.Z_pos += this.ballState.Vz;

                // Ball bouncing off walls (X and Y walls bounce, Z walls have different behavior)
                if (this.ballState.X_pos < -gameAreaSize.width / 2 || this.ballState.X_pos > gameAreaSize.width / 2) {
                    this.ballState.Vx *= -1;
                    this.ballState.X_pos = Math.max(Math.min(this.ballState.X_pos, gameAreaSize.width / 2), -gameAreaSize.width / 2);
                }
                if (this.ballState.Y_pos < -gameAreaSize.height / 2 || this.ballState.Y_pos > gameAreaSize.height / 2) {
                    this.ballState.Vy *= -1;
                    this.ballState.Y_pos = Math.max(Math.min(this.ballState.Y_pos, gameAreaSize.height / 2), -gameAreaSize.height / 2);
                }

                // Ball bouncing off front wall (opposite to AI paddle)
                if (this.ballState.Z_pos > gameAreaSize.depth / 2) {
                    this.ballState.Vz *= -1;
                    this.ballState.Z_pos = gameAreaSize.depth / 2;
                }

                // Check paddle collision
                if (this.ballState.Z_pos <= paddleZ + 0.05 && 
                    Math.abs(this.ballState.X_pos - this.paddleState.X_paddle) < this.paddleState.paddle_width / 2 &&
                    Math.abs(this.ballState.Y_pos - this.paddleState.Y_paddle) < this.paddleState.paddle_height / 2) {
                    this.ballState.Vz *= -1;
                    this.ballState.Z_pos = paddleZ + 0.05;
                    this.score++;
                }

                // Reset if ball goes too far back
                if (this.ballState.Z_pos < -1.2) {
                    this.misses++;
                    this.reset_random();
                    this.isRunning = true;
                }

                // Update 3D objects
                this.ball.position.set(this.ballState.X_pos, this.ballState.Y_pos, this.ballState.Z_pos);
                this.paddle.position.set(this.paddleState.X_paddle, this.paddleState.Y_paddle, paddleZ);
                this.intercept.position.set(intercept.x, intercept.y, paddleZ);
                this.updateStats(action, intercept);
            }

            animate() {
                requestAnimationFrame(()=>this.animate());
                this.updateSimulation();
                this.renderer.render(this.scene, this.camera);
            }

            start() { this.isRunning=true; }
            pause() { this.isRunning=false; }
            reset() {
                this.isRunning=false;
                this.ballState={ X_pos:0, Y_pos:0, Z_pos:0.8, Vx:0.02, Vy:0.015, Vz:-0.03 };
                this.paddleState={ X_paddle:0, Y_paddle:0, paddle_speed:0.015, paddle_width:0.3, paddle_height:0.3 };
                this.score=0; this.misses=0;
                this.updateStats();
            }
            reset_random() {
                this.isRunning=false;
                this.ballState.X_pos = (Math.random() - 0.5) * gameAreaSize.width * 0.5;
                this.ballState.Y_pos = (Math.random() - 0.5) * gameAreaSize.height * 0.5;
                this.ballState.Z_pos = 0.8;
                this.ballState.Vx = (Math.random() - 0.5) * 0.04;
                this.ballState.Vy = (Math.random() - 0.5) * 0.04;
                this.ballState.Vz = -0.02 - Math.random() * 0.02;
                this.paddleState={ X_paddle:0, Y_paddle:0, paddle_speed:0.015, paddle_width:0.3, paddle_height:0.3 };
                this.score=0;
                this.updateStats();
            }
        }

        // Button event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            experimentLeft.start();
            experimentRight.start();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            experimentLeft.pause();
            experimentRight.pause();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        });

        document.getElementById('lessSpeed').addEventListener('click', () => {
            experimentLeft.ballState.Vx -= experimentLeft.ballState.Vx / 4;
            experimentLeft.ballState.Vy -= experimentLeft.ballState.Vy / 4;
            experimentLeft.ballState.Vz -= experimentLeft.ballState.Vz / 4;
            experimentRight.ballState.Vx -= experimentRight.ballState.Vx / 4;
            experimentRight.ballState.Vy -= experimentRight.ballState.Vy / 4;
            experimentRight.ballState.Vz -= experimentRight.ballState.Vz / 4;
        });

        document.getElementById('moreSpeed').addEventListener('click', () => {
            experimentLeft.ballState.Vx += experimentLeft.ballState.Vx / 4;
            experimentLeft.ballState.Vy += experimentLeft.ballState.Vy / 4;
            experimentLeft.ballState.Vz += experimentLeft.ballState.Vz / 4;
            experimentRight.ballState.Vx += experimentRight.ballState.Vx / 4;
            experimentRight.ballState.Vy += experimentRight.ballState.Vy / 4;
            experimentRight.ballState.Vz += experimentRight.ballState.Vz / 4;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            experimentLeft.reset_random();
            experimentRight.ballState = { ...experimentLeft.ballState };
            experimentRight.paddleState = { ...experimentLeft.paddleState };
            experimentLeft.score = 0;
            experimentRight.score = 0;
            experimentLeft.misses = 0;
            experimentRight.misses = 0;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            experimentLeft.start();
            experimentRight.start();
        });

        // Stats toggle
        const moveStatsBtn = document.getElementById('moveStatsBtn');
        const statsContainer = document.getElementById('stats-container');

        statsContainer.style.display = 'none';
        let statsHidden = true;

        moveStatsBtn.addEventListener('click', () => {
            if (statsHidden) {
                statsContainer.style.display = 'flex';
                statsContainer.style.flexDirection = 'column';
                moveStatsBtn.textContent = 'Stats ↑';
            } else {
                statsContainer.style.display = 'none';
                moveStatsBtn.textContent = 'Stats ↓';
            }
            statsHidden = !statsHidden;
        });

        // Resize handler
        window.addEventListener('resize', () => {
            experimentLeft.resize();
            experimentRight.resize();
        });

        // Enhanced touch and mouse controls for mobile
        let isDragging = false;
        let lastX = 0, lastY = 0;

        // Mouse events (for desktop)
        function handleStart(e) {
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            lastX = clientX;
            lastY = clientY;
            
            // Prevent default to avoid scrolling on mobile
            if (e.touches) e.preventDefault();
        }

        function resizeCanvases() {
            const predictive = document.getElementById('predictiveAI');
            const reactive = document.getElementById('reactiveAI');

            // Match the container size
            const container = document.getElementById('container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            if (window.innerWidth <= 768) {
                // Mobile: stack vertically
                predictive.width = containerWidth;
                predictive.height = containerHeight / 2;
                reactive.width = containerWidth;
                reactive.height = containerHeight / 2;
            } else {
                // Desktop: side by side
                predictive.width = containerWidth / 2;
                predictive.height = containerHeight;
                reactive.width = containerWidth / 2;
                reactive.height = containerHeight;
            }
        }

        // Run on page load
        window.addEventListener('load', resizeCanvases);

        // Run on window resize
        window.addEventListener('resize', resizeCanvases);

        function handleEnd(e) {
            isDragging = false;
            if (e.touches) e.preventDefault();
        }

        function handleMove(e) {
            if (!isDragging) return;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const deltaX = clientX - lastX;
            const deltaY = clientY - lastY;

            [experimentLeft.camera, experimentRight.camera].forEach(camera => {
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(camera.position);
                spherical.theta -= deltaX * 0.01;
                spherical.phi += deltaY * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                camera.position.setFromSpherical(spherical);
                camera.lookAt(0, 0, 0);
            });

            lastX = clientX;
            lastY = clientY;
            
            if (e.touches) e.preventDefault();
        }

        // Touch events for mobile
        document.addEventListener('touchstart', handleStart, { passive: false });
        document.addEventListener('touchend', handleEnd, { passive: false });
        document.addEventListener('touchmove', handleMove, { passive: false });

        // Mouse events for desktop
        document.addEventListener('mousedown', handleStart);
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('mousemove', handleMove);

        // Zoom with wheel (desktop) and pinch (mobile)
        document.addEventListener('wheel', e => {
            [experimentLeft.camera, experimentRight.camera].forEach(camera => {
                const distance = camera.position.length();
                const newDistance = Math.max(1, Math.min(10, distance + e.deltaY * 0.01));
                camera.position.normalize().multiplyScalar(newDistance);
            });
        });

        // Initialize experiments
        const experimentLeft = new PaddleExperiment(document.getElementById('predictiveAI'), predictiveAiWeights, 'stats_left', 'predictive');
        const experimentRight = new PaddleExperiment(document.getElementById('reactiveAI'), reactiveAiWeights, 'stats_right', 'reactive');
        
        experimentLeft.animate();
        experimentRight.animate();
        experimentLeft.reset();
        experimentRight.reset();
    </script>
</body>
</html>